# cnec.jp ウェブアプリケーション修正内容テストガイド

## 修正された問題と検証方法

### 1. キャンペーン申請の406エラー修正

**修正内容:**
- `applications`テーブルを使用するようにデータ構造を統一
- 申請データの型変換とバリデーション強化
- エラーハンドリングの改善

**テスト方法:**
1. キャンペーン詳細ページにアクセス
2. 申請フォームに必要情報を入力
3. 申請ボタンをクリック
4. 成功メッセージが表示されることを確認
5. データベースに正しく保存されていることを確認

**期待結果:**
- 406エラーが発生しない
- 申請データが正常に保存される
- 成功メッセージが表示される

### 2. ポイント出金システムの修正

**修正内容:**
- Supabaseライブラリ関数を使用した出金処理
- `withdrawals`テーブルと`user_points`テーブルの統合
- 最小出金額（1,000ポイント）の設定
- 多言語対応のエラーメッセージ

**テスト方法:**
1. MyPageにアクセス
2. 「出金申請」ボタンをクリック
3. 出金フォームに情報を入力
4. 出金申請を送信
5. ポイント残高が正しく更新されることを確認

**期待結果:**
- 出金申請が正常に処理される
- ユーザーのポイント残高が適切に減算される
- 出金履歴に記録される

### 3. MyPageのUI言語一貫性修正

**修正内容:**
- ハードコードされた韓国語テキストを日本語に変更
- 動的言語切り替えの実装
- プレースホルダーテキストの多言語対応

**テスト方法:**
1. MyPageにアクセス
2. 言語設定を日本語に変更
3. すべてのテキストが日本語で表示されることを確認
4. 編集フォームのプレースホルダーも日本語になることを確認

**期待結果:**
- すべてのUI要素が選択した言語で表示される
- 韓国語のハードコードされたテキストが残っていない

### 4. 管理者レポートページのデータ同期修正

**修正内容:**
- Supabaseライブラリ関数の優先使用
- フォールバック機能の実装
- エラーハンドリングとログの強化
- 分析データの自動生成

**テスト方法:**
1. 管理者権限でログイン
2. CompanyReportページにアクセス
3. CampaignReportページにアクセス
4. データが正常に読み込まれることを確認
5. 分析データが表示されることを確認

**期待結果:**
- レポートデータが正常に読み込まれる
- 分析グラフとチャートが表示される
- エラーが発生した場合もフォールバック処理が動作する

## 作成されたSQLスクリプト

### 1. SUPABASE_FIX_SCRIPT.sql
- 基本的なテーブル構造とRLSポリシーの設定

### 2. withdrawal_system_fix.sql
- 出金システム用のテーブル構造修正
- ポイント管理関数の作成
- 権限設定の最適化

## 技術的改善点

### データベース層
- RLS（Row Level Security）の適切な設定
- インデックスの追加による性能向上
- 関数とトリガーによる自動化

### アプリケーション層
- Supabaseライブラリ関数の統一使用
- エラーハンドリングの強化
- フォールバック機能の実装

### UI/UX層
- 多言語対応の完全実装
- 一貫したユーザー体験の提供
- レスポンシブデザインの維持

## 今後の推奨事項

### 1. 定期的なデータベースメンテナンス
- 不要なデータの清理
- インデックスの最適化
- バックアップの確認

### 2. 監視とログ
- エラーログの定期的な確認
- パフォーマンス監視の実装
- ユーザー行動の分析

### 3. セキュリティ
- RLSポリシーの定期的な見直し
- アクセス権限の監査
- セキュリティアップデートの適用

## 緊急時の対応

### データベース接続エラー
1. Supabaseダッシュボードでサービス状態を確認
2. 接続文字列とAPIキーを確認
3. フォールバック処理が動作しているか確認

### 申請処理エラー
1. ブラウザのコンソールでエラーログを確認
2. Supabaseのログを確認
3. データベースのRLSポリシーを確認

### UI表示エラー
1. 言語設定を確認
2. ブラウザキャッシュをクリア
3. 最新のビルドがデプロイされているか確認
